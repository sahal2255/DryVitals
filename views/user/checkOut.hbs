<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description"
		content="Responsive Bootstrap4 Shop Template, Created by Imran Hossain from https://imransdesign.com/">

	<!-- title -->
	<title>Check Out</title>

	<!-- favicon -->
	{{!--
	<link rel="shortcut icon" type="image/png" href="/assets/img/favicon.png"> --}}
	<!-- google font -->
		<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">

	<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Poppins:400,700&display=swap" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

	<!-- fontawesome -->
	<link rel="stylesheet" href="/assets/css/all.min.css">
	<!-- bootstrap -->
	<link rel="stylesheet" href="/assets/bootstrap/css/bootstrap.min.css">
	<!-- owl carousel -->
	<link rel="stylesheet" href="/assets/css/owl.carousel.css">
	<!-- magnific popup -->
	<link rel="stylesheet" href="/assets/css/magnific-popup.css">
	<!-- animate css -->
	<link rel="stylesheet" href="/assets/css/animate.css">
	<!-- mean menu css -->
	<link rel="stylesheet" href="/assets/css/meanmenu.min.css">
	<!-- main style -->
	<link rel="stylesheet" href="/assets/css/main.css">
	<!-- responsive -->
	<link rel="stylesheet" href="/assets/css/responsive.css">
	<style>
		body {
			background-color: gainsboro;
			/* Set background color for the body */
		}





		.cart-details {
			margin-top: 20px;
		}

		.cart-details>div {
			display: flex;
			justify-content: space-between;
			margin-bottom: 5px;
		}

		.cart-details span:first-child {
			font-weight: bold;
		}

		*

		/* Custom styling for list-group radio buttons */
		.list-group-item {
			border: none;
		}

		.list-group-item .form-check {
			margin-bottom: 0;
		}

		.list-group-item .form-check-input {
			margin-top: 5px;
		}
		.error{
			color: red;
		}
		#alertMessage{
			color: red;
		}
	</style>

</head>

<body>

	<!--PreLoader-->
	{{!-- <div class="loader">
		<div class="loader-inner">
			<div class="circle"></div>
		</div>
	</div> --}}
	<!--PreLoader Ends-->

	<!-- header -->
	<div class="top-header-area" id="sticker">
		<div class="container">
			<div class="row">
				<div class="col-lg-12 col-sm-12 text-center">
					<div class="main-menu-wrap">
						<!-- logo -->
						<div class="site-logo">
							{{!-- <a href="/"> --}}
								<img src="/assets/img/mainLogo.png" alt="fghf">
							</a>
						</div>
						<!-- logo -->

						<!-- menu start -->
						<nav class="main-menu">
							<ul>
								{{!-- <li class="current-list-item"><a href="#">Home</a>
									<ul class="sub-menu">
										<li><a href="index.html">Static Home</a></li>
										<li><a href="index_2.html">Slider Home</a></li>
									</ul>
								</li> --}}
								{{!-- <li><a href="about.html">About</a></li> --}}
								<li><a href="#">Pages</a>
									<ul class="sub-menu">
										{{!-- <li><a href="404.html">404 page</a></li> --}}
										{{!-- <li><a href="about.html">About</a></li> --}}
										<li><a href="/cart">Cart</a></li>
										<li><a href="/checkout">Check Out</a></li>
										{{!-- <li><a href="contact.html">Contact</a></li> --}}
										{{!-- <li><a href="news.html">News</a></li> --}}
										<li><a href="/product">Product</a></li>
									</ul>
								</li>
								
								{{!-- <li><a href="contact.html">Contact</a></li> --}}
								<li><a href="/product">Shop</a>
									<ul class="sub-menu">
										<li><a href="/product">Shop</a></li>
										{{!-- <li><a href="checkout.html">Check Out</a></li> --}}
										{{!-- <li><a href="single-product.html">Single Product</a></li> --}}
										<li><a href="/cart">Cart</a></li>
									</ul>
								</li>
								<li>
									<div class="header-icons">
										
										<a class="shopping-cart" href="/cart"><i class="fas fa-shopping-cart"></i></a>
										<a class="mobile-hide wishlist-bar-icon" href="/wishlist"><i
												class="bi bi-heart-fill"></i></a>
										<a class="mobile-hide person-bar-icon" href="/profile"><i
												class="bi bi-person-circle"></i></a>
									</div>
								</li>
							</ul>
						</nav>
						{{!-- <a class="mobile-show search-bar-icon" href="#"><i class="fas fa-search"></i></a> --}}
						<div class="mobile-menu"></div>
						<!-- menu end -->
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- end header -->

	<!-- search area -->
	<div class="search-area">
		<div class="container">
			<div class="row">
				<div class="col-lg-12">
					<span class="close-btn"><i class="fas fa-window-close"></i></span>
					<div class="search-bar">
						<div class="search-bar-tablecell">
							<h3>Search For:</h3>
							<input type="text" placeholder="Keywords">
							<button type="submit">Search <i class="fas fa-search"></i></button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- end search arewa -->

	<!-- breadcrumb-section -->
	<div class="breadcrumb-section breadcrumb-bg">
		<div class="container">
			<div class="row">
				<div class="col-lg-8 offset-lg-2 text-center">
					<div class="breadcrumb-text">
						<p>Fresh and Organic</p>
						<h1>Check Out Product</h1>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- end breadcrumb section -->

	<!-- check out section -->
{{#if cartItems}}
	<div class="d-flex justify-content-center align-items-center" style="height: 100vh;">
		<div class="container-fluid ">
			<div class="row justify-content-evenly">
				<div class="col-12 col-md-6 col-lg-6" style="background-color: rgb(255, 255, 255); color: rgb(0, 0, 0); padding: 20px;">
					<h1 class="text-center ">Cart Items</h1>
					<hr>

					<div class="table-responsive">
						<table class="table table-striped table-bordered">
							<thead class="cart-item">
								<tr>
									<th>Product Name</th>
									<th>Quantity</th>
									<th>Variant</th>
									<th>Price</th>
								</tr>
							</thead>
							<tbody>
								{{#each cartItems.product}}
								<tr>
									<td>{{productName}}</td>
									<td>{{quantity}}</td>
									<td>{{productVariant}}</td>
									<td>₹{{productPrice}}</td>
								</tr>
								{{/each}}
							</tbody>
						</table>
					</div>



					<hr style="width: 100%; height: 1px; background-color: #000; border: none;">

					<div class="cart-details">
						<div class="total">
							<span>Total:</span>
							<span class="amount">₹{{total}}</span> <!-- Example value, replace with actual total -->
						</div>
						<div class="shipping">
							<span>Shipping:</span>
							<span class="amount">₹{{shipping}}</span>
							<!-- Example value, replace with actual shipping -->
						</div>
						<hr style="width: 100%; height: 1px; background-color: #000; border: none;">
						<div class="total-amount">
							<span>Total Amount:</span>
							<span class="amount">₹{{totalAmount}}</span>
							<!-- Example value, replace with actual total amount -->
							<input type="hidden" id="total-amount" value="{{totalAmount}}">

						</div>
					</div>
				</div>

				<div class="col col-md-4 " style="background-color: rgb(255, 255, 255); padding: 20px;">
					<div class="row gy-4 mx-5">
						<div class="col-12" style="background-color: rgb(255, 255, 255); padding: 0;">
							<h3 style="margin: 10px 0;" class="text-center">Address</h3>
							<div >
								<div class="mb-3">
									<h5><label class="form-label">Select Address:</label></h5><br>
									{{#each userAddress}}
									<div class="form-check">
										<input class="form-check-input" type="radio" name="addressOption"
											id="addressOption{{@index}}" value="{{@index}}" >
											<input type="hidden" value="{{this.pincode}}">
										<label class="form-check-label ml-2"
											for="addressOption{{@index}}">{{this.address}},{{this.place}},{{this.pincode}}</label>
									</div>
									{{/each}}
								</div>


				
							</div>
							<hr style="width: 100%; height: 1px; background-color: #000; border: none;">
							<p class="d-inline-flex gap-1 ">
								<button class="btn btn-primary" type="button" data-bs-toggle="collapse"
									data-bs-target="#collapseExample" aria-expanded="false"
									aria-controls="collapseExample">
									Add Address
								</button>
							</p>
							<div class="collapse" id="collapseExample">
								<div class="card card-body">
									<!-- Address form -->
									<form id="addressForm" action="/saveAddress" method="POST" onsubmit="return saveAddress(event)">
    <div class="row mb-3">
        <label for="inputAddress" class="col-sm-2 col-form-label">Address</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="address" placeholder="Address" name="address">
        <p id="addressError" class="error"></p> <!-- Error message for address -->
        </div>
    </div>
    <div class="row mb-3">
        <label for="inputCity" class="col-sm-2 col-form-label">District</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="district" name="district" placeholder="District">
        <p id="districtError" class="error"></p> <!-- Error message for district -->
        </div>
    </div>
    <div class="row mb-3">
        <label for="inputState" class="col-sm-2 col-form-label">Place</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="place" name="place" placeholder="Place">
        <p id="placeError" class="error"></p> <!-- Error message for place -->
        </div>
    </div>
    <div class="row mb-3">
        <label for="inputZip" class="col-sm-2 col-form-label">Pincode</label>
        <div class="col-sm-10">
            <input type="number" class="form-control" id="pincode" name="pincode" placeholder="Pincode">
        <p id="pincodeError" class="error"></p> <!-- Error message for pincode -->
        </div>
    </div>
    <div class="row mb-3">
        <div class="col-sm-10 offset-sm-2">
            <button type="button" class="btn btn-primary" id="submitAddress">Save Address</button>
        </div>
    </div>
</form>

								</div>
							</div>


						</div>
					<hr style="width: 100%; height: 1px; background-color: #000; border: none;">
					</div>
					<div class="row gy-4 mt-5 mx-5 ">
						<div class="col-12" style="background-color: rgb(255, 255, 255); padding: 0;">
							<p id="alertMessage"></p>
							<h3 style="margin: 10px 0;" class="text-center">Payment Method</h3>
							<hr>
							<div class="form-check ">
								<input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio1"
									value="COD">
								<label class="form-check-label" for="inlineRadio1">COD</label>
							</div>
							<div class="form-check">
								<input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio2"
									value="ONLINE">
								<label class="form-check-label" for="inlineRadio2">Online</label>
							</div>
						</div>
						<div class="d-flex justify-content-center ">
					<button id="placeOrderBtn" class="btn btn-lg btn-success" onclick="placeOrder()">Place Order</button>
						</div>
					</div>
				</div>

			</div>
		</div>
	</div>

{{else}}
    <div class="container" style="height: 250px; background-color: #ffcccc; display: flex; justify-content: center; align-items: center;">
        <div class="not-product" style="text-align: center;">
            <h1 style="font-size: 24px; color: #ff0000;">No Products in Cart</h1>
            <p style="font-size: 16px; color: #333;">Your cart is empty. Please add products to your cart.</p>
        </div>
    </div>
{{/if}}

<script>
document.addEventListener("DOMContentLoaded", function() {
    document.getElementById("submitAddress").addEventListener("click", saveAddress);
});

async function saveAddress(event) {
    event.preventDefault();

    var district = document.getElementById("district").value;
    var place = document.getElementById("place").value.trim();
    var address = document.getElementById("address").value.trim();
    var pincode = document.getElementById("pincode").value.trim();

    // Reset error messages
    document.getElementById("districtError").innerText = "";
    document.getElementById("placeError").innerText = "";
    document.getElementById("addressError").innerText = "";
    document.getElementById("pincodeError").innerText = "";

    // Validation
    var isValid = true;

    if (district === "") {
        document.getElementById("districtError").innerText = "Please enter your district";
        isValid = false;
    }

    if (place === "") {
        document.getElementById("placeError").innerText = "Please enter your place";
        isValid = false;
    }

    if (address === "") {
        document.getElementById("addressError").innerText = "Please enter your address";
        isValid = false;
    }

    if (pincode === "") {
        document.getElementById("pincodeError").innerText = "Please enter your pincode";
        isValid = false;
    } else if (!isValidPincode(pincode)) {
        document.getElementById("pincodeError").innerText = "Pincode should be exactly 6 digits";
        isValid = false;
    }

    if (isValid) {
        try {
            // Construct the new address object
            const newAddress = {
                district: district,
                place: place,
                address: address,
                pincode: pincode
            };

            // Send a request to your server to update the user's address
            const response = await axios.post('/saveAddress', { newAddress });

            // Handle the response from the server
            console.log('Address saved successfully:', response.data);
            // Show SweetAlert notification
            Swal.fire({
                icon: 'success',
                title: 'Success',
                text: 'Your address has been saved successfully!',
                confirmButtonText: 'OK'
            });
        } catch (error) {
            console.error('Error saving address:', error);
            // Show SweetAlert for error
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: 'Something went wrong! Please try again later.',
                confirmButtonText: 'OK'
            });
        }
    }
}

function isValidPincode(pincode) {
    // Pincode validation (6 digits)
    var pincodeRegex = /^\d{6}$/;
    return pincodeRegex.test(pincode);
}


window.placeOrder = function () {
    var selectedPaymentMethod = document.querySelector('input[name="inlineRadioOptions"]:checked');
    var selectedAddressOption = document.querySelector('input[name="addressOption"]:checked');
var alertMessageElement=document.getElementById('alertMessage')
    if ( !selectedAddressOption) {
        alertMessageElement.innerHTML='Please Select an address option'
        return;
    }
    if (!selectedPaymentMethod) {
        alertMessageElement.innerHTML='Please Select a Payment method'
        return;
    }

    if (selectedPaymentMethod.value === "COD") {
	var selectedAddressOption = document.querySelector('input[name="addressOption"]:checked');
        if (!selectedAddressOption) {
            alert("Please select an address option.");
            return;
        }

        var selectedPincode = selectedAddressOption.parentElement.querySelector('.form-check-label').textContent.split(',')[5];
		console.log('selected picode',selectedPincode)
        axios.post('/placeOrder', {
            selectedPaymentMethod: 'COD',
			selectedPincode:selectedPincode
        })
        .then(function (response) {
            console.log('Order placed successfully!');
            Swal.fire({
                icon: 'success',
                title: 'Success!',
                text: 'Order placed successfully!',
            })
            .then((result) => {
                if (result.isConfirmed) {
                    window.location.href = '/order';
                }
            });
        })
        .catch(function (error) {
            console.error('Error placing order:', error);
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: 'Failed to place order. Please try again later.',
            });
        });
    } else if (selectedPaymentMethod.value === 'ONLINE') {
        // Handle Online payment method
        const totalAmount = document.getElementById('total-amount').value;
		var selectedPincode = selectedAddressOption.parentElement.querySelector('.form-check-label').textContent.split(',')[5];
		console.log('selected picode',selectedPincode)
        axios.post('/razorpay/placeOrder', { 
            totalAmount: totalAmount,
			selectedPincode: selectedPincode
        })
        .then(response => {
            console.log("Response from server:", response);
            const { orderId, amount } = response.data;

            var options = {
                key: '',
                amount: amount, 
                currency: "INR",
                order_id: orderId,
                name: "Your Company Name",
                description: "Description of the payment",
                handler: function (response) {
                    console.log("Razorpay response:", response);
                    axios.post('/placeOrder', {
                        selectedPaymentMethod: 'Online',
						selectedPincode: selectedPincode,
                        razorpayOrderId: orderId,
                        razorpayPaymentId: response.razorpay_payment_id
                    })
                    .then(orderResponse => {
                        console.log('Order placed successfully!', orderResponse.data.order);
                        Swal.fire({
                            icon: 'success',
                            title: 'Success!',
                            text: 'Order placed successfully!',
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.href = '/order';
                            }
                        });
                    })
                    .catch(error => {
                        console.error('Error placing order:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Oops...',
                            text: 'Failed to place order. Please try again later.',
                        });
                    });
                }
            };

            var rzp = new Razorpay(options);
            rzp.open();
        })
        .catch(error => {
            console.error("Error while placing order with Razorpay:", error);
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: 'Failed to place order with Razorpay. Please try again later.',
            });
        });
    } else {
        alert("Please select a payment method.");
    }
}

</script>

	<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
		integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
		crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
		integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
		crossorigin="anonymous"></script>

	<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

	<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<!-- jquery -->
	<script src="/assets/js/jquery-1.11.3.min.js"></script>
	<!-- bootstrap -->
	<script src="/assets/bootstrap/js/bootstrap.min.js"></script>
	<!-- count down -->
	<script src="/assets/js/jquery.countdown.js"></script>
	<!-- isotope -->
	<script src="/assets/js/jquery.isotope-3.0.6.min.js"></script>
	<!-- waypoints -->
	<script src="/assets/js/waypoints.js"></script>
	<!-- owl carousel -->
	<script src="/assets/js/owl.carousel.min.js"></script>
	<!-- magnific popup -->
	<script src="/assets/js/jquery.magnific-popup.min.js"></script>
	<!-- mean menu -->
	<script src="/assets/js/jquery.meanmenu.min.js"></script>
	<!-- sticker js -->
	<script src="/assets/js/sticker.js"></script>
	<!-- main js -->
	<script src="/assets/js/main.js"></script>

</body>

</html>