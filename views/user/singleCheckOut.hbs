<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description"
        content="Responsive Bootstrap4 Shop Template, Created by Imran Hossain from https://imransdesign.com/">

    <!-- title -->
    <title>Check Out</title>

    <!-- favicon -->
    {{!--
    <link rel="shortcut icon" type="image/png" href="/assets/img/favicon.png"> --}}
    <!-- google font -->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Poppins:400,700&display=swap" rel="stylesheet">
    <!-- fontawesome -->
    <link rel="stylesheet" href="/assets/css/all.min.css">
    <!-- bootstrap -->
    <link rel="stylesheet" href="/assets/bootstrap/css/bootstrap.min.css">
    <!-- owl carousel -->
    <link rel="stylesheet" href="/assets/css/owl.carousel.css">
    <!-- magnific popup -->
    <link rel="stylesheet" href="/assets/css/magnific-popup.css">
    <!-- animate css -->
    <link rel="stylesheet" href="/assets/css/animate.css">
    <!-- mean menu css -->
    <link rel="stylesheet" href="/assets/css/meanmenu.min.css">
    <!-- main style -->
    <link rel="stylesheet" href="/assets/css/main.css">
    <!-- responsive -->
    <link rel="stylesheet" href="/assets/css/responsive.css">
    <style>
        .radio {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            /* Adding margin to space out from other elements */
        }

        .radio input[type="radio"] {
            margin-right: 0px;
            /* Decrease the margin between radio button and label */
            vertical-align: middle;
        }

        .labelfor {
            vertical-align: middle;
            margin-right: 100px;
        }
        .error {
			color: red;
			font-size: 14px;
		}

		.select-container {
			position: relative;
			width: 200px;
		}

		/* Style the select box */
		.select-box {
			width: 100%;
			padding: 10px;
			border: 1px solid #ccc;
			border-radius: 5px;
			background-color: #fff;
			font-size: 16px;
		}

		/* Style the arrow */
		.select-arrow {
			position: absolute;
			top: 50%;
			right: 10px;
			transform: translateY(-50%);
		}

		/* Style the options */
		.select-box option {
			background-color: #fff;
			color: #000;
		}

		/* Hover effect */
		.select-box:hover {
			border-color: #666;
		}

		/* Focus effect */
		.select-box:focus {
			outline: none;
			border-color: #333;
		}
    </style>

</head>

<body>

    <!--PreLoader-->
    {{!-- <div class="loader">
        <div class="loader-inner">
            <div class="circle"></div>
        </div>
    </div> --}}
    <!--PreLoader Ends-->

    <!-- header -->
    <div class="top-header-area" id="sticker">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 col-sm-12 text-center">
                    <div class="main-menu-wrap">
                        <!-- logo -->
                        <div class="site-logo">
                            <a href="index.html">
                                <img src="/assets/img/mainLogo.png" alt="">
                            </a>
                        </div>
                        <!-- logo -->

                        <!-- menu start -->
                        <nav class="main-menu">
                            <ul>
                                <li class="current-list-item"><a href="#">Home</a>
                                    <ul class="sub-menu">
                                        <li><a href="index.html">Static Home</a></li>
                                        <li><a href="index_2.html">Slider Home</a></li>
                                    </ul>
                                </li>
                                <li><a href="about.html">About</a></li>
                                <li><a href="#">Pages</a>
                                    <ul class="sub-menu">
                                        <li><a href="404.html">404 page</a></li>
                                        <li><a href="about.html">About</a></li>
                                        <li><a href="cart.html">Cart</a></li>
                                        <li><a href="checkout.html">Check Out</a></li>
                                        <li><a href="contact.html">Contact</a></li>
                                        <li><a href="news.html">News</a></li>
                                        <li><a href="shop.html">Shop</a></li>
                                    </ul>
                                </li>
                                <li><a href="news.html">News</a>
                                    <ul class="sub-menu">
                                        <li><a href="news.html">News</a></li>
                                        <li><a href="single-news.html">Single News</a></li>
                                    </ul>
                                </li>
                                <li><a href="contact.html">Contact</a></li>
                                <li><a href="shop.html">Shop</a>
                                    <ul class="sub-menu">
                                        <li><a href="shop.html">Shop</a></li>
                                        <li><a href="checkout.html">Check Out</a></li>
                                        <li><a href="single-product.html">Single Product</a></li>
                                        <li><a href="cart.html">Cart</a></li>
                                    </ul>
                                </li>
                                <li>
                                    <div class="header-icons">
                                        <a class="shopping-cart" href="cart.html"><i
                                                class="fas fa-shopping-cart"></i></a>
                                        <a class="mobile-hide search-bar-icon" href="#"><i
                                                class="fas fa-search"></i></a>
                                    </div>
                                </li>
                            </ul>
                        </nav>
                        <a class="mobile-show search-bar-icon" href="#"><i class="fas fa-search"></i></a>
                        <div class="mobile-menu"></div>
                        <!-- menu end -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- end header -->

    <!-- search area -->
    <div class="search-area">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <span class="close-btn"><i class="fas fa-window-close"></i></span>
                    <div class="search-bar">
                        <div class="search-bar-tablecell">
                            <h3>Search For:</h3>
                            <input type="text" placeholder="Keywords">
                            <button type="submit">Search <i class="fas fa-search"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- end search arewa -->

    <!-- breadcrumb-section -->
    <div class="breadcrumb-section breadcrumb-bg">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 offset-lg-2 text-center">
                    <div class="breadcrumb-text">
                        <p>Fresh and Organic</p>
                        <h1>Check Out Product</h1>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- end breadcrumb section -->

    <!-- check out section -->
    <div class="checkout-section mt-150 mb-150">
        <div class="container">
            <div class="row">
                <div class="col-lg-8">
                    <div class="checkout-accordion-wrap">
                        <div class="accordion" id="accordionExample">
                            <div class="card single-accordion">
                                <div class="card-header" id="headingOne">
                                    <h5 class="mb-0">
                                        <button class="btn btn-link" type="button" data-toggle="collapse"
                                            data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                            Billing Address
                                        </button>
                                    </h5>
                                </div>

                                <div id="collapseOne" class="collapse show" aria-labelledby="headingOne"
                                    data-parent="#accordionExample">
                                    <div class="card-body">
                                        <div class="billing-address-form">
                                            <form action="/saveAddress" method="POST"
												onsubmit="return saveAddress(event)">
												{{#if userAddress}}
												{{#with userAddress.[0]}}
												<!-- Access the first address object if exists -->
												<p><input type="text" placeholder="Name" id="name" name="Name"
														value="{{name}}"></p>
												<p id="nameError" class="error"></p>
												<p><input type="email" placeholder="Email" id="email" name="email"
														value="{{email}}"></p>
												<p id="emailError" class="error"></p>
												<p><input type="number" placeholder="Phone" id="phone"
														name="phoneNumber" value="{{phoneNumber}}"></p>
												<p id="phoneError" class="error"></p>
												<p><input type="text" value="{{district}}"></p>
												<p><input type="text" placeholder="Place" id="place" name="place"
														value="{{place}}"></p>
												<p id="placeError" class="error"></p>
												{{#if address}}
												<p><input type="text" style="height: 100px;" value="{{address}}"></p>
												{{else}}
												<p><textarea placeholder="Address" id="address"
														name="address"></textarea></p>
												<p id="addressError" class="error"></p>
												{{/if}}
												<p><input type="number" placeholder="Pincode" id="pincode"
														name="pincode" value="{{pincode}}"></p>
												<p id="pincodeError" class="error"></p>
												{{/with}}
												{{else}}
												<!-- If no userAddress exists, display form fields to input a new address -->
												<p><input type="text" placeholder="Name" id="name" name="Name"></p>
												<p id="nameError" class="error"></p>
												<p><input type="email" placeholder="Email" id="email" name="email"></p>
												<p id="emailError" class="error"></p>
												<p><input type="number" placeholder="Phone" id="phone"
														name="phoneNumber"></p>
												<p id="phoneError" class="error"></p>
												<p>
													<select name="district" id="district" name="district">
														<option value="" selected disabled>Select District</option>
														<option value="Thiruvananthapuram">Thiruvananthapuram</option>
														<option value="Kollam">Kollam</option>
														<option value="Alappuzha">Alappuzha</option>
														<option value="Pathanamthitta">Pathanamthitta</option>
														<option value="Kottayam">Kottayam</option>
														<option value="Idukki">Idukki</option>
														<option value="Ernakulam">Ernakulam</option>
														<option value="Thrissur">Thrissur</option>
														<option value="Palakkad">Palakkad</option>
														<option value="Malappuram">Malappuram</option>
														<option value="Kozhikode">Kozhikode</option>
														<option value="Wayanad">Wayanad</option>
														<option value="Kannur">Kannur</option>
														<option value="Kasaragod">Kasaragod</option>
													</select>
												</p>
												<p id="selectError" class="error"></p>
												<p><input type="text" placeholder="Place" id="place" name="place"></p>
												<p id="placeError" class="error"></p>
												<p><textarea placeholder="Address" id="address"
														name="address"></textarea></p>
												<p id="addressError" class="error"></p>
												<p><input type="number" placeholder="Pincode" id="pincode"
														name="pincode"></p>
												<p id="pincodeError" class="error"></p>
												{{/if}}
												{{#if userAddress}}
												<p>hello</p>
												{{else}}
												<button type="submit" id="submitAddress">Save Address</button>
												{{/if}}
											</form>
                                        </div>
                                    </div>
                                </div>
                                

                        </div>

                    </div>
                </div>
<div class="select-container">
							<select class="select-box" name="payment-method" id="payment-method">
								<option value="defult" selected>Delivery</option>
								<option value="cash-on-delivery">Cash On Delivery</option>
								<option value="razorpay">RazorPay</option>
							</select>
						</div>
                <div class="col-lg-4">
                    <div class="order-details-wrap">
                        <table class="order-details">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Price</th>
                                    <th>MRP</th>
                                    <th>Variant</th>
                                </tr>
                            </thead>
                            {{#if result}}
                            <tbody class="order-details-body">
                                <tr>
                                    <td>{{result.productName}}</td>
                                    <td>₹{{result.price}}</td>
                                    <td><del>₹{{result.mrp}}</del></td>
                                    <td>{{result.selectedVariant}}</td>
                                </tr>
                            </tbody>
                            {{else}}
                            <p>No product details available.</p>
                            {{/if}}


                            <tbody class="checkout-details">
                                <tr>
                                    <td>MRP</td>
                                    <td>₹ <del>{{result.mrp}}</del></td>
                                </tr>
                                <tr>
                                    <td>Subtotal</td>
                                    <td>₹{{result.price}}</td>
                                </tr>
                                <tr>
                                    <td>Shipping</td>
                                    <td>₹{{shipping}}</td>
                                </tr>
                                <tr>
                                    <td>Total</td>
                                    <td>₹{{totalamount}}</td>
                                    
                                    <input type="hidden" id="total-amount" value="{{totalamount}}">

                                </tr>
                            </tbody>
                        </table>
                    <button id="placeOrderBtn" onclick="placeOrder()">Place Order</button>                    </div>
                </div>
            </div>
        </div>
    </div>
    
<script>
    		function saveAddress(event) {
			event.preventDefault();
			console.log("Save Address button clicked");
			// Get form input values
			var name = document.getElementById("name").value.trim();
			var email = document.getElementById("email").value.trim();
			var phone = document.getElementById("phone").value.trim();
			var district = document.getElementById("district").value;
			var place = document.getElementById("place").value.trim();
			var address = document.getElementById("address").value.trim();
			var pincode = document.getElementById("pincode").value.trim();

			// Reset error messages
			document.getElementById("nameError").innerText = "";
			document.getElementById("emailError").innerText = "";
			document.getElementById("phoneError").innerText = "";
			document.getElementById("selectError").innerText = "";
			document.getElementById("placeError").innerText = "";
			document.getElementById("addressError").innerText = "";
			document.getElementById("pincodeError").innerText = "";

			// Validation
			var isValid = true;

			if (name === "") {
				document.getElementById("nameError").innerText = "Please enter your name";
				isValid = false;
			}

			if (email === "") {
				document.getElementById("emailError").innerText = "Please enter your email";
				isValid = false;
			} else if (!isValidEmail(email)) {
				document.getElementById("emailError").innerText = "Please enter a valid email address";
				isValid = false;
			}

			if (phone === "") {
				document.getElementById("phoneError").innerText = "Please enter your phone number";
				isValid = false;
			} else if (!isValidPhone(phone)) {
				document.getElementById("phoneError").innerText = "Phone Number Must Be 10 digits";
				isValid = false;
			}

			if (district === "") {
				document.getElementById("selectError").innerText = "Please select a district";
				isValid = false;
			}

			if (place === "") {
				document.getElementById("placeError").innerText = "Please enter your place";
				isValid = false;
			}

			if (address === "") {
				document.getElementById("addressError").innerText = "Please enter your address";
				isValid = false;
			}

			if (pincode === "") {
				document.getElementById("pincodeError").innerText = "Please enter your pincode";
				isValid = false;
			} else if (!isValidPincode(pincode)) {
				document.getElementById("pincodeError").innerText = "Pincode should be exactly 6 digits";
				isValid = false;
			}

			if (isValid) {
				// Send form data to the server using Axios
				axios.post('/saveAddress', {
					Name: name,
					email: email,
					phoneNumber: phone,
					district: district,
					place: place,
					address: address,
					pincode: pincode
				})
					.then(function (response) {
						console.log('Form data saved successfully:', response.data);
						// Show SweetAlert notification
						Swal.fire({
							icon: 'success',
							title: 'Success',
							text: 'Your address has been saved successfully!',
							confirmButtonText: 'OK'
						});
					})
					.catch(function (error) {
						console.error('Error saving form data:', error);
						// Show SweetAlert for error
						Swal.fire({
							icon: 'error',
							title: 'Oops...',
							text: 'Something went wrong! Please try again later.',
							confirmButtonText: 'OK'
						});
					});
			}
		}

		function isValidEmail(email) {
			// Basic email validation
			var emailRegex = /\S+@\S+\.\S+/;
			return emailRegex.test(email);
		}
		function isValidPhone(phone) {
			// Phone number validation (10 digits)
			var phoneRegex = /^\d{10}$/;
			return phoneRegex.test(phone);
		}

		function isValidPincode(pincode) {
			// Pincode validation (6 digits)
			var pincodeRegex = /^\d{6}$/;
			return pincodeRegex.test(pincode);
		}


window.placeOrder = function () {
    var hasAddress = {{#if userAddress}}true{{else}}false{{/if}};
    if (!hasAddress) {
        // User does not have a saved address, show message and return
        alert("Please save your address before placing the order.");
        return;
    }

    var selectedPaymentMethod = document.getElementById('payment-method').value;
    if (selectedPaymentMethod === "defult") {
        alert("Please select a payment method.");
        return;
    }

	if(selectedPaymentMethod==='cash-on-delivery'){

    axios.post('/placeOrder', {
        selectedPaymentMethod: selectedPaymentMethod
    })
    .then(function (response) {
        console.log('Order placed successfully!');
        Swal.fire({
            icon: 'success',
            title: 'Success!',
            text: 'Order placed successfully!',
        })
        .then((result) => {
            if (result.isConfirmed) {
                window.location.href = '/order';
            }
        });
    })
    .catch(function (error) {
        console.error('Error placing order:', error);
        Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'Failed to place order. Please try again later.',
        });
    });
}
else if (selectedPaymentMethod === 'razorpay') {
        // Handle Razorpay payment method
        const totalAmount = document.getElementById('total-amount').value;

        axios.post('/razorpay/placeOrder', { 
            totalAmount: totalAmount
        })
        .then(response => {
            console.log("Response from server:", response);
            // Extract Razorpay order details from the server response
            const { orderId, amount } = response.data;

            // Initialize Razorpay payment
            var options = {
                key: '',
                amount: amount, // amount in the smallest currency unit
                currency: "INR",
                order_id: orderId,
                name: "Your Company Name",
                description: "Description of the payment",
                handler: function (response) {
                    // Handle successful payment response
                    console.log("Razorpay response:", response);
                    // Call the server to store the order
                    axios.post('/placeOrder', {
                        selectedPaymentMethod: selectedPaymentMethod,
                        razorpayOrderId: orderId,
                        razorpayPaymentId: response.razorpay_payment_id
                    })
                    .then(orderResponse => {
                        console.log('Order placed successfully!', orderResponse.data.order);
                        Swal.fire({
                            icon: 'success',
                            title: 'Success!',
                            text: 'Order placed successfully!',
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.href = '/order';
                            }
                        });
                    })
                    .catch(error => {
                        console.error('Error placing order:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Oops...',
                            text: 'Failed to place order. Please try again later.',
                        });
                    });
                }
            };

            var rzp = new Razorpay(options);
            rzp.open();
        })
        .catch(error => {
            console.error("Error while placing order with Razorpay:", error);
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: 'Failed to place order with Razorpay. Please try again later.',
            });
        });
    }
}
</script>

    <!-- jquery -->
    <script src="/assets/js/jquery-1.11.3.min.js"></script>
    <!-- bootstrap -->
    <script src="/assets/bootstrap/js/bootstrap.min.js"></script>
    <!-- count down -->
    <script src="/assets/js/jquery.countdown.js"></script>
    <!-- isotope -->
    <script src="/assets/js/jquery.isotope-3.0.6.min.js"></script>
    <!-- waypoints -->
    <script src="/assets/js/waypoints.js"></script>
    <!-- owl carousel -->
    <script src="/assets/js/owl.carousel.min.js"></script>
    <!-- magnific popup -->
    <script src="/assets/js/jquery.magnific-popup.min.js"></script>
    <!-- mean menu -->
    <script src="/assets/js/jquery.meanmenu.min.js"></script>
    <!-- sticker js -->
    <script src="/assets/js/sticker.js"></script>
    <!-- main js -->
    <script src="/assets/js/main.js"></script>

</body>

</html>